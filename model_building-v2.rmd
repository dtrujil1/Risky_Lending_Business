---
title: "Model Building"
output: github_document
---

```{r setup, include=F}
knitr::opts_chunk$set(
  fig.path = "markdown_figs/data_preparation-"
)
```

```{r message=F}
library(magrittr)
library(dplyr)
library(randomForest)
library(caret)
library(doParallel)
```

```{r}
load(file = "data/data_preparation-v2.RData")
```

#### Building a Model

```{r}
loss_fct <- as.factor(loss)

levels(loss_fct) <- c( "ND", "D")

summary(loss_fct)
```


```{r}
train_df <- cbind(good_predictors, loss_fct) %>% mutate(loss = loss_fct) %>% dplyr::select(-loss_fct)
train_df_pca <- cbind(pca_df, loss_fct) %>% mutate(loss = loss_fct) %>% dplyr::select(-loss_fct)
train_df_hcorr <- cbind(good_predictors_rm_hcorr, loss_fct) %>% mutate(loss = loss_fct) %>% dplyr::select(-loss_fct)
head(train_df)
head(train_df_pca)
head(train_df_hcorr)
```

## Spliting data into Training and Validation

### Training and Validation using All Good Predictors

```{r}
set.seed(123)

train_index <- createDataPartition(
  train_df$loss,
  p = 0.8,
  list = F,
  times = 1
)

train_data <- train_df[train_index,]
val_data <- train_df[-train_index,]
```

### Training and Validation using PCA Components (95% Variance)

```{r}
set.seed(123)

train_index_pca <- createDataPartition(
  train_df_pca$loss,
  p = 0.8,
  list = F,
  times = 1
)

train_data_pca <- train_df_pca[train_index,]
val_data_pca <- train_df_pca[-train_index,]
```

### Training and Validation using Good Predictors w/ High Correlated Variables Removed

```{r}
set.seed(123)

train_index_hcorr <- createDataPartition(
  train_df_hcorr$loss,
  p = 0.8,
  list = F,
  times = 1
)

train_data_hcorr <- train_df_hcorr[train_index,]
val_data_hcorr <- train_df_hcorr[-train_index,]
```

## Training a LASSO Model (caret)

### LASSO Model (Caret) All Good Predictors

```{r}
cluster <- makePSOCKcluster(detectCores() - 1)
registerDoParallel(cluster)

ctrl_opts <- trainControl(
  method = "repeatedcv",
  number = 5,
  allowParallel = T,
  classProbs = T,
  summaryFunction = twoClassSummary
)

model_glmnet <- train(
  loss ~ .,
  data = train_data,
  method = "glmnet",
  metric = "ROC",
  trControl = ctrl_opts
)

stopCluster(cluster)
registerDoSEQ()
```

```{r}
model_glmnet
```

```{r}
plot(model_glmnet)
```

### LASSO Model (Caret) PCA Components

```{r}
cluster <- makePSOCKcluster(detectCores() - 1)
registerDoParallel(cluster)

ctrl_opts <- trainControl(
  method = "repeatedcv",
  number = 5,
  allowParallel = T,
  classProbs = T,
  summaryFunction = twoClassSummary
)

model_glmnet_pca <- train(
  loss ~ .,
  data = train_data_pca,
  method = "glmnet",
  metric = "ROC",
  trControl = ctrl_opts
)

stopCluster(cluster)
registerDoSEQ()
```

```{r}
model_glmnet_pca
```

```{r}
plot(model_glmnet_pca)
```

### Training a LASSO Model Using Good Predictor Variables w/ Highly Correlated (90%) Variables Removed

```{r}
cluster <- makePSOCKcluster(detectCores() - 1)
registerDoParallel(cluster)

ctrl_opts <- trainControl(
  method = "repeatedcv",
  number = 5,
  allowParallel = T,
  classProbs = T,
  summaryFunction = twoClassSummary
)

model_glmnet_hcorr <- train(
  loss ~ .,
  data = train_data_hcorr,
  method = "glmnet",
  metric = "ROC",
  trControl = ctrl_opts
)

stopCluster(cluster)
registerDoSEQ()
```

```{r}
model_glmnet_hcorr
```

```{r}
plot(model_glmnet_hcorr)
```

### Training a Random Forest Model (caret)

```{r}
cluster <- makePSOCKcluster(detectCores() - 1)
registerDoParallel(cluster)

ctrl_opts <- trainControl(
  method = "repeatedcv",
  number = 5,
  allowParallel = T,
  classProbs = T,
  summaryFunction = twoClassSummary
)

model_rf <- train(
  loss ~ .,
  data = train_data,
  method = "rf",
  metric = "ROC",
  trControl = ctrl_opts
)

stopCluster(cluster)
registerDoSEQ()
```

```{r}
model_rf
```

### Evaluating The LASSO Model (caret) Accuracy

#### LASSO Model (Caret) Using All Good Predictors

```{r}
model_preds <- predict(model_glmnet, newdata = val_data)

confusionMatrix(model_preds, val_data$loss)
```

#### LASSO Model (Caret) PCA Components

```{r}
model_preds <- predict(model_glmnet_pca, newdata = val_data_pca)

confusionMatrix(model_preds, val_data_pca$loss)
```
#### LASSO Model (Caret) Using Good Predictor Variables w/ Highly Correlated (90%) Variables Removed

```{r}
model_preds <- predict(model_glmnet_hcorr, newdata = val_data_hcorr)

confusionMatrix(model_preds, val_data_hcorr$loss)
```

## Saving Models
```{r}
save(good_predictors, loss, model_glmnet, file = "data/model_building-auc71_52.RData")
save(pca_df, loss, model_glmnet_pca, file = "data/model_building-pca-auc68_95.RData")
save(good_predictors_rm_hcorr, loss, model_glmnet_hcorr, file = "data/model_building-rm_hcorr-auc70_64.RData")
```
