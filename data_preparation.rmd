---
title: "Data Preparation & Cleaning"
output: github_document
---

```{r setup, include=F}
knitr::opts_chunk$set(
  fig.path = "markdown_figs/data_preparation-"
)
```

```{r message=F}
library(magrittr)
library(dplyr)
library(ggplot2)
library(glmnet)
library(randomForest)
library(caret)
library(data.table)
library(doParallel)
library(klaR)
```

## Loading the dataset

```{r}
loan_dt <- fread("data/train_v3.csv")
loan_df <- as.data.frame(loan_dt)
```

## Cleaning The Data Up

### Recoding The Predictor Variables

```{r}
loan_df <- loan_df %>% mutate_all(as.numeric)
```

### Recoding The Target Variable

```{r}
target_var <- loan_df %>%
  select(loss) %>%
  mutate_at(c("loss"), ~ifelse(. > 0, 1, 0)) %>%
  mutate_at(c("loss"), as.factor)
```

### Removing Near Zero Variance Variables

```{r}
registerDoParallel(6)

nzv_cols <- nearZeroVar(loan_df, allowParallel = T, foreach = T)
loan_df_cln <- loan_df[, -nzv_cols]
```

### Quick Inputation of `NA`s

```{r}
impute_model <- preProcess(loan_df_cln, method = "medianImpute")
loan_df_cln2 <- predict(impute_model, loan_df_cln)
```

```{r}
anyNA(loan_df_cln2)
```

### Preparing The Data for Feature Selection

```{r}
loan_df_cln3 <- loan_df_cln2 %>% dplyr::select(-c("V1", "id"))

predictor_vars <- data.matrix(loan_df_cln3)

loss <- target_var %>% use_series("loss") %>% as.vector()
```

## Feature Selection and Extraction

### Selecting Features using LASSO

```{r}
set.seed(2019)
cluster <- makePSOCKcluster(detectCores() - 1)
registerDoParallel(cluster)

cv_fit <- cv.glmnet(
  predictor_vars, loss,
  type.measure = "class",
  family = "binomial",
  alpha = 1,
  parallel = T
)

stopCluster(cluster)
registerDoSEQ()
```

```{r}
plot(cv_fit)
```

```{r}
lasso_model <- glmnet(
  predictor_vars, loss,
  lambda = cv_fit$lambda.min,
  family = "binomial",
  alpha = 1
)
```

```{r}
plot(lasso_model, xvar="lambda", label=TRUE)
```

```{r}
coeff_matrix <- coef(lasso_model, s = "lambda.min")

coeff_matrix
```

```{r}
lasso_coefs <- data.frame(
  name = coeff_matrix@Dimnames[[1]][coeff_matrix@i + 1],
  coefficient = coeff_matrix@x
  ) %>%
  filter(name !="(Intercept)") %>%
  use_series("name") %>%
  as.character()

lasso_coefs
```

#### Separating Good Predictor Variables from the Noise

```{r}
good_pred_var <- loan_df_cln3 %>% dplyr::select(lasso_coefs)

head(good_pred_var)
```

#### Applying PCA to Compresss Good Predictor Variables

```{r}
pre_process_model <- preProcess(
  good_pred_var,
  method = c( "center", "scale"),
  pcaComp = 30
)

good_pred_var_cln <- predict(pre_process_model, good_pred_var)

head(good_pred_var_cln)
```

```{r}
pca_model <- prcomp(good_pred_var_cln)

summary(pca_model)
```

###### Select The First 57 Principal Components That explain 95% of the Variance

```{r}
pca_df <- predict(pca_model, good_pred_var_cln) %>% as.data.frame() %>% select(1:57)

head(pca_df)
```

```{r}
save(good_pred_var, pca_df, loss, file = "data/data_preparation.RData")
```